<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Text Detection and Recognition</title>
    <script async src="opencv.js" type="text/javascript"></script>
    <script src="tesseract.js"></script>
    
</head>
<body>
<h2>Text Detection and Recognition</h2>

<div>
    <img  id="imageSrc" alt="No Image" />
    <input type="file" id="fileInput" name="file" />
    <canvas id="canvasOutput"></canvas>
</div>

<script type="text/javascript">
let imgElement = document.getElementById("imageSrc");
let inputElement = document.getElementById("fileInput");
let canvas = document.getElementById("canvasOutput");

inputElement.addEventListener("change", (e) => {
    imgElement.src = URL.createObjectURL(e.target.files[0]);
    imgElement.onload = function() {
        processImage();
    };
}, false);

function processImage() {
    
    let src = cv.imread(imgElement);
    let gray = new cv.Mat();
    let threshold = new cv.Mat();
    let threshold2 = new cv.Mat();
    // Convert to grayscale
    cv.cvtColor(src, gray, cv.COLOR_RGB2GRAY,0);

    // Apply binary thresholding
    cv.adaptiveThreshold(gray, threshold,255, cv.ADAPTIVE_THRESH_GAUSSIAN_C,  cv.THRESH_BINARY_INV,43,43);//THESE LAST TO ELEMENTS
    //cv.threshold(gray, threshold, 0,255, cv.THRESH_BINARY +cv.THRESH_OTSU);
    
    // Show result
    cv.imshow('canvasOutput', threshold);
    
    // Convert image to base64 for OCR
    let dataUrl = canvas.toDataURL('image/png');
    performOCR(dataUrl);

    // Clean up
    src.delete();
    gray.delete();
    threshold.delete();
}

function performOCR(imageData) {
    // Convert base64 to binary data
    fetch(imageData)
        .then(res => res.arrayBuffer())
        .then(buffer => {
            // Create a Blob from the binary data
            const blob = new Blob([buffer]);

            // Perform OCR using Tesseract.js
            Tesseract.recognize(
                blob,
                'tur', // Language
                {
                    oem: 1, // OCR Engine Mode
                    psm: 6, // Page Segmentation Mode
                }
            ).then(({ data: { text } }) => {
                console.log('Detected text:', text);
            }).catch(err => {
                console.error('OCR error:', err);
            });
        });
}
</script>
</body>
</html>